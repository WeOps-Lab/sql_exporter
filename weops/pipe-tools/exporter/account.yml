apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: create-mssql-account-cron
  namespace: mssql
spec:
  schedule: "*/5 * * * *"
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          nodeSelector:
            node-role: worker
          containers:
          - name: create-mssql-2022-account
            image: registry-svc:25000/library/mssql-tools:latest
            command:
              [
                "/opt/mssql-tools/bin/sqlcmd",
                "-S",
                "mssqlserver-2022.mssql",
                "-U",
                "SA",
                "-P",
                "Weops123!",
                "-I",
                "-Q",
                "CREATE LOGIN monitoring_user WITH PASSWORD = 'Weops123!'; GRANT VIEW SERVER STATE TO monitoring_user; USE master; CREATE USER monitoring_user FOR LOGIN monitoring_user; ALTER ROLE db_datareader ADD MEMBER monitoring_user;",
              ]
          - name: create-mssql-2019-account
            image: registry-svc:25000/library/mssql-tools:latest
            command:
              [
                "/opt/mssql-tools/bin/sqlcmd",
                "-S",
                "mssqlserver-2019.mssql",
                "-U",
                "SA",
                "-P",
                "Weops123!",
                "-I",
                "-Q",
                "CREATE LOGIN monitoring_user WITH PASSWORD = 'Weops123!'; GRANT VIEW SERVER STATE TO monitoring_user; USE master; CREATE USER monitoring_user FOR LOGIN monitoring_user; ALTER ROLE db_datareader ADD MEMBER monitoring_user;",
              ]
          - name: create-mssql-2017-account
            image: registry-svc:25000/library/mssql-tools:latest
            command:
              [
                "/opt/mssql-tools/bin/sqlcmd",
                "-S",
                "mssql-2017-mssql-linux",
                "-U",
                "SA",
                "-P",
                "Weops123!",
                "-I",
                "-Q",
                "CREATE LOGIN monitoring_user WITH PASSWORD = 'Weops123!'; GRANT VIEW SERVER STATE TO monitoring_user; USE master; CREATE USER monitoring_user FOR LOGIN monitoring_user; ALTER ROLE db_datareader ADD MEMBER monitoring_user;",
              ]
          restartPolicy: Never